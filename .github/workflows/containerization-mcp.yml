name: Containerization MCP Analysis

# This workflow demonstrates the use of the Azure containerization-assist MCP server
# to analyze a repository for containerization readiness.
# 
# The workflow:
# 1. Installs the containerization-assist-mcp package via npm
# 2. Uses the MCP SDK to call the analyze-repo tool
# 3. Analyzes the Spring PetClinic repository to detect:
#    - Programming language and frameworks
#    - Build system (Maven/Gradle)
#    - Dependencies
#    - Exposed ports
#
# Reference: https://github.com/Azure/containerization-assist

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analyze-repo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Create analysis script
        run: |
          cat > analyze.mjs << 'EOF'
          // Import the MCP SDK to use containerization tools programmatically
          import { createApp } from 'containerization-assist-mcp';
          
          async function main() {
            try {
              console.log('üöÄ Starting repository analysis with containerization-assist MCP...');
              console.log('Repository path:', process.cwd());
              
              // Create the app runtime instance (provides access to all MCP tools)
              const app = createApp();
              
              // Execute the analyze-repo tool to detect technologies and dependencies
              // This demonstrates the success criteria: using the MCP server to call analyze_repo tool
              const result = await app.execute('analyze-repo', {
                repositoryPath: process.cwd(),
                depth: 3,
                includeTests: false
              });
              
              if (result.ok) {
                console.log('\n‚úÖ Analysis successful!');
                console.log('\nüìä Analysis Results:');
                console.log(JSON.stringify(result.value, null, 2));
                
                // Display detected modules
                if (result.value.modules && result.value.modules.length > 0) {
                  console.log('\nüîç Detected Modules:');
                  result.value.modules.forEach(module => {
                    console.log(`  - ${module.name} (${module.language || 'unknown'})`);
                    if (module.frameworks && module.frameworks.length > 0) {
                      console.log(`    Frameworks: ${module.frameworks.map(f => f.name).join(', ')}`);
                    }
                  });
                }
                
                console.log('\n‚ú® Successfully called analyze-repo tool via MCP server!');
                process.exit(0);
              } else {
                console.error('\n‚ùå Analysis failed:', result.error);
                process.exit(1);
              }
            } catch (error) {
              console.error('\n‚ùå Error during analysis:', error.message);
              console.error('Stack trace:', error.stack);
              process.exit(1);
            }
          }
          
          main();
          EOF
      
      - name: Run analyze-repo tool
        run: |
          # Install containerization-assist-mcp package 
          npm install containerization-assist-mcp
          # Run the analysis script that calls the MCP server's analyze-repo tool
          node analyze.mjs
      
      - name: Upload analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: containerization-analysis
          path: |
            analyze.mjs
          retention-days: 5
