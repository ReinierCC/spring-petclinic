# Azure Deployment Plan for spring-petclinic Project

## **Goal**
Deploy the Spring PetClinic application to Azure using Azure Developer CLI (AZD) with Azure Container Apps and Azure Database for PostgreSQL.

## **Project Information**
**Spring PetClinic**  
- **Stack**: Spring Boot 4.0.0 with Java 17  
- **Type**: Web application for managing veterinary clinic operations
- **Containerization**: Dockerfile created at root level
- **Dependencies**: PostgreSQL database for persistent storage
- **Hosting**: Azure Container Apps

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**
```mermaid
graph TD
%% Services
svcazurecontainerapps_petclinic["`Name: petclinic
Path: /home/runner/work/spring-petclinic/spring-petclinic
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_petclinic("`petclinic (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azure_postgresql["`Azure Database for PostgreSQL`"]
azure_acr["`Azure Container Registry`"]
azure_keyvault["`Azure Key Vault`"]
end
subgraph "Supporting Services"
azure_appinsights["`Application Insights`"]
azure_loganalytics["`Log Analytics Workspace`"]
azure_identity["`User-Assigned Managed Identity`"]
end
%% Relationships
svcazurecontainerapps_petclinic --> |"hosted on"| azurecontainerapps_petclinic
azurecontainerapps_petclinic -.-> |"depends on"| azure_postgresql
azurecontainerapps_petclinic -.-> |"pulls image from"| azure_acr
azurecontainerapps_petclinic -.-> |"gets secrets from"| azure_keyvault
azurecontainerapps_petclinic -.-> |"sends telemetry to"| azure_appinsights
azure_identity -.-> |"has AcrPull role on"| azure_acr
azure_identity -.-> |"has secrets access to"| azure_keyvault
```

**Resource Relationships:**
- The container app gets its image from the Azure Container Registry
- The container app connects to Azure Database for PostgreSQL using connection information stored in Key Vault
- The container app uses managed identity for secure access to Key Vault and Container Registry
- Application Insights collects telemetry and logs for monitoring
- Log Analytics Workspace aggregates logs from all services

## **Recommended Azure Resources**

**Application: spring-petclinic**
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption plan with 0.5 vCPU and 1 GB memory per replica
- **Configuration**:
    - Language: java (Spring Boot with Java 17)
    - Environment Variables:
        - `SPRING_PROFILES_ACTIVE=postgres`
        - `SPRING_DATASOURCE_URL` (from Key Vault)
        - `SPRING_DATASOURCE_USERNAME` (from Key Vault)
        - `SPRING_DATASOURCE_PASSWORD` (from Key Vault)
        - `APPLICATIONINSIGHTS_CONNECTION_STRING` (from Application Insights)
    - dockerFilePath: `/home/runner/work/spring-petclinic/spring-petclinic/Dockerfile`
    - dockerContext: `/home/runner/work/spring-petclinic/spring-petclinic`
- **Dependencies**:
    - **Dependency Name**: Azure Database for PostgreSQL
    - **SKU**: Burstable B1ms (1 vCore, 2 GB RAM) - suitable for development/testing
    - **Service Type**: Azure Database for PostgreSQL Flexible Server
    - **Connection Type**: Connection string via Key Vault with Managed Identity
    - **Environment Variables**:
        - Database name: `petclinic`
        - PostgreSQL version: 16

## **Recommended Supporting Services**:
- **Application Insights**: For monitoring, logging, and performance tracking
- **User-Assigned Managed Identity**: For secure access to Azure resources
- **Log Analytics Workspace**: Centralized logging for all services
- **Key Vault**: Store database connection strings and secrets securely
- **Container Registry**: Store and manage container images

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have permissions to read secrets from Key Vault
- User-Assigned Managed Identity must be assigned to Container Apps
- AcrPull role assignment: User managed identity must have **AcrPull** role ("7f951dda-4ed3-4680-a7ca-43fe172d538d") assigned to the container registry
- Network security: Configure firewall rules on PostgreSQL to allow Azure services
- Use Key Vault references for sensitive configuration values

## **Execution Steps**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan.**

### Execution Steps:
1. **Containerization**:
    - [x] Dockerfile exists at `/home/runner/work/spring-petclinic/spring-petclinic/Dockerfile`
    - [x] .dockerignore created for optimized builds
    - Output: Docker artifacts ready

2. **Create Azure Infrastructure Files for AZD**:
    1. Provisioning tool: AZD. Expected files: `azure.yaml`, `infra/main.bicep`, `infra/main.parameters.json`
    2. Call tool `appmod-get-available-region-sku` to get available region and SKUs for all needed Azure resource types
    3. Generate the required infrastructure files:
        - Call tool `appmod-get-iac-rules` to get the rules for file generation
        - Generate `azure.yaml` configuration
        - Generate `infra/main.bicep` with all required resources
        - Generate `infra/main.parameters.json` with parameter definitions
        - Generate supporting bicep modules for resources
    4. Validate bicep files for syntax and best practices

3. **Env setup for azd**:
    1. Install AZ CLI and AZD if not installed
    2. Run `azd env new <envName> --no-prompt` to create a new environment
    3. Review `infra/main.bicep` and `infra/main.parameters.json` for environment variables
    4. Set environment variables using `azd env set <key> <value>`
    5. Set the Azure subscription (use default subscription)
    6. Set `AZURE_RESOURCE_GROUP` environment variable and create resource group with AZ CLI

4. **Deployment**:
    1. Run `azd provision --preview --no-prompt` to preview infrastructure deployment
    2. Run `azd up --no-prompt` to deploy infrastructure and application
    3. If region errors occur, run `azd down --force --no-prompt` and retry with different region
    4. Validate deployment by checking application logs with tool `appmod-get-azd-app-logs`

5. **Summarize Deployment Result**:
    1. Use `appmod-summarize-result` tool to generate deployment summary
    2. Generate file: `.azure/summary.copilotmd`

## **Progress Tracking**
Track progress in `.azure/progress.copilotmd` file with:
- ‚úÖ Completed tasks  
- üî≤ Pending tasks  
- ‚ùå Failed tasks with error notes

If a step fails, log the error, fix the issue, and retry until the step completes.
