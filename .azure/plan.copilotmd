# Azure Deployment Plan for spring-petclinic Project

## **Goal**
Deploy the Spring PetClinic application to Azure Kubernetes Service (AKS) with PostgreSQL database support using Azure CLI.

## **Project Information**

**Spring PetClinic**  
- **Stack**: Spring Boot 4.0.0, Java 17  
- **Type**: Pet clinic management web application  
- **Containerization**: Dockerfile created (multi-stage build)  
- **Dependencies**: PostgreSQL database  
- **Hosting**: Azure Kubernetes Service (AKS)

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurekubernetesservice_petclinic["`Name: petclinic
Path: /home/runner/work/spring-petclinic/spring-petclinic
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph akscluster["Azure Kubernetes Service (AKS) Cluster"]
azurekubernetesservice_petclinic("`petclinic (Containerized Service)`")
end
akscluster:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azure_postgresql["`Azure Database for PostgreSQL Flexible Server`"]
azure_acr["`Azure Container Registry`"]
end
subgraph "Supporting Services"
azure_appinsights["`Application Insights`"]
azure_loganalytics["`Log Analytics Workspace`"]
azure_keyvault["`Key Vault`"]
azure_identity["`User-Assigned Managed Identity`"]
end
%% Relationships
svcazurekubernetesservice_petclinic --> |"hosted on"| azurekubernetesservice_petclinic
azurekubernetesservice_petclinic -.-> |"depends on"| azure_postgresql
azurekubernetesservice_petclinic -.-> |"pulls image from"| azure_acr
azurekubernetesservice_petclinic -.-> |"logs to"| azure_appinsights
azurekubernetesservice_petclinic -.-> |"uses identity"| azure_identity
azure_appinsights -.-> |"logs to"| azure_loganalytics
azure_identity -.-> |"accesses"| azure_keyvault
azure_identity -.-> |"pulls from"| azure_acr
```

- The AKS cluster hosts the containerized petclinic application.
- The petclinic service pulls its container image from Azure Container Registry.
- The application connects to Azure Database for PostgreSQL Flexible Server for data persistence.
- Application Insights collects telemetry and logs to Log Analytics Workspace.
- Managed Identity is used for secure access to Key Vault and ACR without credentials.

## **Recommended Azure Resources**

Application spring-petclinic:
- Hosting Service Type: Azure Kubernetes Service (AKS)
- SKU: Standard_D2s_v3 (2 vCPUs, 8 GB memory per node, suitable for production workloads)
- Configuration:
    - language: java
    - Environment Variables:
        - SPRING_PROFILES_ACTIVE: postgres
        - SPRING_DATASOURCE_URL: (from Key Vault)
        - SPRING_DATASOURCE_USERNAME: (from Key Vault)
        - SPRING_DATASOURCE_PASSWORD: (from Key Vault)
    - dockerFilePath: /home/runner/work/spring-petclinic/spring-petclinic/Dockerfile
    - dockerContext: /home/runner/work/spring-petclinic/spring-petclinic
- Dependencies Resource:
    - Dependency Name: PostgreSQL
    - SKU: Standard_B2s (2 vCores, 4 GB memory, suitable for small to medium workloads)
    - Service Type: Azure Database for PostgreSQL Flexible Server
    - Connection Type: Connection string stored in Key Vault, accessed via Managed Identity
    - Environment Variables:
        - POSTGRES_DB: petclinic
        - POSTGRES_USER: petclinic
        - POSTGRES_PASSWORD: (generated securely)

## **Recommended Supporting Services**:
- Application Insights: Monitor application performance and availability
- User-Assigned Managed Identity: Secure access to Azure resources without credentials
- Log Analytics Workspace: Centralized logging for all services
- Key Vault: Store database connection strings and sensitive configuration
- Container Registry: Store and manage container images

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have permissions to access the Key Vault.
- User-Assigned Managed Identity must be assigned to the AKS cluster.
- AcrPull role assignment: User managed identity must have **AcrPull** role ("7f951dda-4ed3-4680-a7ca-43fe172d538d") assigned to the container registry.
- Network security: Use private endpoints where possible.
- PostgreSQL: Enable SSL enforcement and use firewall rules to restrict access.

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan.**

Execution Steps:

1. **Containerization**:
    - [x] Dockerfile created at /home/runner/work/spring-petclinic/spring-petclinic/Dockerfile
    - [ ] Build and test Docker image locally
    - Output: Docker artifacts

2. **Environment Setup for Azure CLI**:
    - [ ] Install Azure CLI if not installed
    - [ ] Login to Azure (az login)
    - [ ] Set default subscription or use provided subscription ID
    - Subscription ID: Use default subscription

3. **Provision Azure Infrastructure with Azure CLI**:
    - [ ] Provisioning tool: Azure CLI
    - [ ] Expected files: Bash (.sh) script for provisioning
    - [ ] Get available regions and SKUs by calling `appmod-get-available-region-sku` for required resource types:
        - Microsoft.ContainerService/managedClusters (AKS)
        - Microsoft.ContainerRegistry/registries (ACR)
        - Microsoft.DBforPostgreSQL/flexibleServers (PostgreSQL)
        - Microsoft.ManagedIdentity/userAssignedIdentities
        - Microsoft.KeyVault/vaults
        - Microsoft.OperationalInsights/workspaces
        - Microsoft.Insights/components
        - Microsoft.Compute/virtualMachines (for AKS node quota check)
    - [ ] Generate Azure CLI provisioning script using guidelines from `appmod-get-iac-rules`
    - [ ] Run Azure CLI script to provision resources
    - [ ] Fix any errors and retry if needed
    - Output: Provisioned Azure resources

4. **Deployment**:
    - [ ] Build container image
    - [ ] Push image to Azure Container Registry
    - [ ] Update Kubernetes manifests for AKS compatibility
    - [ ] Configure Kubernetes secrets for database connection
    - [ ] Deploy to AKS using kubectl
    - [ ] Verify deployment and pod status
    - [ ] Expose service via LoadBalancer or Ingress
    - Output: Running application on AKS

5. **Deployment Validation**:
    - [ ] Check pods are running and healthy
    - [ ] Verify application is accessible
    - [ ] Test database connectivity
    - [ ] Check Application Insights telemetry

6. **Summarize Deployment Result**:
    - [ ] Use `appmod-summarize-result` tool to summarize the deployment result
    - Output: .azure/summary.copilotmd

## **Progress Tracking**

Progress will be tracked in `.azure/progress.copilotmd` after each step completion.
